<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYDRA Admin Panel</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-orange: #f97316;
            --border-color: #475569;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent-green);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background: var(--accent-green);
            color: white;
            width: 100%;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header h1 {
            color: var(--accent-green);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
        }
        
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-card .value.green { color: var(--accent-green); }
        .stat-card .value.blue { color: var(--accent-blue); }
        .stat-card .value.orange { color: var(--accent-orange); }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: var(--accent-green);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .status-active {
            color: var(--accent-green);
        }
        
        .status-inactive {
            color: var(--accent-red);
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .error-msg {
            color: var(--accent-red);
            margin-top: 10px;
            text-align: center;
        }
        
        .success-msg {
            color: var(--accent-green);
            margin-top: 10px;
            text-align: center;
        }
        
        .inline-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .inline-form .form-group {
            margin-bottom: 0;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .inline-form {
                flex-direction: column;
            }
            
            .inline-form .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>üîê HYDRA</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="username" required placeholder="admin">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                <div class="error-msg" id="loginError"></div>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <h1>üìä HYDRA Admin</h1>
            <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</div>
                <div class="value green" id="statTotalTokens">0</div>
            </div>
            <div class="stat-card">
                <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤</div>
                <div class="value green" id="statActiveTokens">0</div>
            </div>
            <div class="stat-card">
                <div class="label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏</div>
                <div class="value blue" id="statActiveProxies">0</div>
            </div>
            <div class="stat-card">
                <div class="label">–ü–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                <div class="value orange" id="statClients">0</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="proxies">–ü—Ä–æ–∫—Å–∏</button>
            <button class="tab" data-tab="tokens">–¢–æ–∫–µ–Ω—ã</button>
            <button class="tab" data-tab="keys">–ö–ª—é—á–∏ –ø—Ä–æ–¥—É–∫—Ç–∞</button>
            <button class="tab" data-tab="default-tokens">–¢–æ–∫–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
        </div>
        
        <!-- Proxies Tab -->
        <div class="tab-content active" id="tab-proxies">
            <div class="card">
                <h2>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∫—Å–∏</h2>
                <div class="form-group">
                    <label>–§–æ—Ä–º–∞—Ç: login:pass@ip:port (–∫–∞–∂–¥—ã–π –ø—Ä–æ–∫—Å–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                    <textarea id="proxyList" placeholder="user1:pass1@192.168.1.1:1080
user2:pass2@192.168.1.2:1080"></textarea>
                </div>
                <div class="inline-form">
                    <div class="form-group" style="flex: 0 0 120px;">
                        <label>–ü—Ä–æ—Ç–æ–∫–æ–ª</label>
                        <select id="proxyProtocol" style="width: 120px;">
                            <option value="http" selected>HTTP</option>
                            <option value="socks5">SOCKS5</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addProxies()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∫—Å–∏</button>
                </div>
                <div class="success-msg" id="proxySuccess"></div>
            </div>
            
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–∫—Å–∏</h2>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-danger" onclick="clearAllProxies()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-primary" onclick="checkProxiesHealth()" id="checkHealthBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-danger" onclick="deleteUnhealthyProxies()" id="deleteUnhealthyBtn">–£–¥–∞–ª–∏—Ç—å –Ω–µ—Ä–∞–±–æ—á–∏–µ</button>
                    <span id="lastHealthCheck" style="color: var(--text-secondary); font-size: 14px; margin-left: 10px;"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü—Ä–æ–∫—Å–∏</th>
                            <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û—à–∏–±–∫–∏</th>
                            <th>–ó–¥–æ—Ä–æ–≤—å–µ</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="proxyTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tokens Tab -->
        <div class="tab-content" id="tab-tokens">
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>Base/Quote</th>
                            <th>DEX</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tokenTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Product Keys Tab -->
        <div class="tab-content" id="tab-keys">
            <div class="card">
                <h2>–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á –ø—Ä–æ–¥—É–∫—Ç–∞</h2>
                <div class="inline-form">
                    <div class="form-group" style="min-width: 210px;">
                        <label style="white-space: nowrap;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="keyUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="min-width: 190px;">
                    </div>
                    <button class="btn btn-primary" onclick="createProductKey()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
                </div>
                <div class="success-msg" id="keySuccess"></div>
            </div>
            
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ö–ª—é—á</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="keysTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Default Tokens Tab -->
        <div class="tab-content" id="tab-default-tokens">
            <div class="card">
                <h2>–ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏). –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∏–º—è —Ç–æ–∫–µ–Ω–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 300px;">
                        <label>–ê–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</label>
                        <textarea id="bulkTokenAddresses" rows="8" placeholder="So11111111111111111111111111111111111111112
EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v
..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: monospace; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="min-width: 200px;">
                        <div class="form-group">
                            <label>DEX</label>
                            <select id="bulkTokenDex" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                                <option value="jupiter">Jupiter (Solana)</option>
                                <option value="pancake">PancakeSwap (BSC)</option>
                                <option value="matcha">Matcha (Base)</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary" onclick="bulkAddDefaultTokens()" style="width: 100%; margin-top: 10px;">
                            –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ
                        </button>
                    </div>
                </div>
                
                <div id="bulkTokenResults" style="margin-top: 15px;"></div>
                <div class="success-msg" id="defaultTokenSuccess"></div>
            </div>
            
            <div class="card">
                <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">–≠—Ç–∏ —Ç–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤—è—Ç—Å—è —É –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.</p>
                <table>
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>Base/Quote</th>
                            <th>DEX</th>
                            <th>–ê–¥—Ä–µ—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="defaultTokensTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('adminToken');
        
        // Check if already logged in
        if (authToken) {
            showDashboard();
        }
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                }
                
                const data = await response.json();
                authToken = data.access_token;
                localStorage.setItem('adminToken', authToken);
                showDashboard();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        });
        
        function showDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadStats();
            loadHealthStatus();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–æ–∫—Å–∏
            loadTokens();
            loadProductKeys();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
            loadDefaultTokens();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            // Refresh stats every 5 seconds
            setInterval(loadStats, 5000);
            // Refresh health status every minute
            setInterval(loadHealthStatus, 60000);
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }
        
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            if (response.status === 401) {
                logout();
                throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
            }
            return response;
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                document.getElementById('statTotalTokens').textContent = stats.total_tokens;
                document.getElementById('statActiveTokens').textContent = stats.active_tokens;
                document.getElementById('statActiveProxies').textContent = stats.active_proxies;
                document.getElementById('statClients').textContent = stats.connected_clients;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // –•—Ä–∞–Ω–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
        let healthResults = {};
        
        async function loadProxies() {
            try {
                const response = await apiCall('/api/admin/proxies');
                const proxies = await response.json();
                const tbody = document.getElementById('proxyTable');
                tbody.innerHTML = proxies.map(p => {
                    const health = healthResults[p.id];
                    let healthCell = '<span style="color: var(--text-secondary);">-</span>';
                    if (health) {
                        if (health.working) {
                            healthCell = `<span style="color: var(--accent-green);">‚úì ${health.response_time}ms</span>`;
                        } else {
                            healthCell = `<span style="color: var(--accent-red);" title="${health.error || '–û—à–∏–±–∫–∞'}">‚úó</span>`;
                        }
                    }
                    return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${maskProxy(p.proxy_string)}</td>
                        <td>${p.protocol.toUpperCase()}</td>
                        <td class="${p.is_active ? 'status-active' : 'status-inactive'}">
                            ${p.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </td>
                        <td>${p.fail_count}</td>
                        <td>${healthCell}</td>
                        <td class="actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleProxy(${p.id})">
                                ${p.is_active ? '–û—Ç–∫–ª' : '–í–∫–ª'}
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteProxy(${p.id})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('Error loading proxies:', error);
            }
        }
        
        async function loadHealthStatus() {
            try {
                const response = await apiCall('/api/admin/proxies/health');
                const data = await response.json();
                if (data.results) {
                    healthResults = {};
                    data.results.forEach(r => {
                        healthResults[r.id] = r;
                    });
                }
                if (data.last_check) {
                    const lastCheck = new Date(data.last_check);
                    document.getElementById('lastHealthCheck').textContent = 
                        `–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${lastCheck.toLocaleString()}`;
                }
                loadProxies();
            } catch (error) {
                console.error('Error loading health status:', error);
            }
        }
        
        async function checkProxiesHealth() {
            const btn = document.getElementById('checkHealthBtn');
            btn.disabled = true;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            
            try {
                const response = await apiCall('/api/admin/proxies/health/check', 'POST');
                const data = await response.json();
                
                if (data.results) {
                    healthResults = {};
                    data.results.forEach(r => {
                        healthResults[r.id] = r;
                    });
                }
                
                document.getElementById('lastHealthCheck').textContent = 
                    `–†–∞–±–æ—Ç–∞—é—Ç: ${data.working}/${data.total}`;
                
                loadProxies();
                loadStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ';
            }
        }
        
        function maskProxy(proxy) {
            // Hide password in display
            const match = proxy.match(/^([^:]+):([^@]+)@(.+)$/);
            if (match) {
                return `${match[1]}:****@${match[3]}`;
            }
            return proxy;
        }
        
        async function addProxies() {
            const text = document.getElementById('proxyList').value;
            const protocol = document.getElementById('proxyProtocol').value;
            const proxies = text.split('\n').map(p => p.trim()).filter(p => p);
            
            if (proxies.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–æ–∫—Å–∏');
                return;
            }
            
            try {
                const response = await apiCall('/api/admin/proxies/bulk', 'POST', {
                    proxies,
                    protocol
                });
                const result = await response.json();
                document.getElementById('proxySuccess').textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${result.added} –ø—Ä–æ–∫—Å–∏`;
                document.getElementById('proxyList').value = '';
                loadProxies();
                loadStats();
                setTimeout(() => {
                    document.getElementById('proxySuccess').textContent = '';
                }, 3000);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏: ' + error.message);
            }
        }
        
        async function toggleProxy(id) {
            try {
                await apiCall(`/api/admin/proxies/${id}/toggle`, 'PUT');
                loadProxies();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function deleteProxy(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–∫—Å–∏?')) return;
            try {
                await apiCall(`/api/admin/proxies/${id}`, 'DELETE');
                loadProxies();
                loadStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function clearAllProxies() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –ø—Ä–æ–∫—Å–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            try {
                await apiCall('/api/admin/proxies', 'DELETE');
                loadProxies();
                loadStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function deleteUnhealthyProxies() {
            // –ù–∞–π—Ç–∏ –Ω–µ—Ä–∞–±–æ—á–∏–µ –ø—Ä–æ–∫—Å–∏ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
            const unhealthyIds = Object.entries(healthResults)
                .filter(([id, health]) => !health.working)
                .map(([id, health]) => parseInt(id));
            
            if (unhealthyIds.length === 0) {
                alert('–ù–µ—Ç –Ω–µ—Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ".');
                return;
            }
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${unhealthyIds.length} –Ω–µ—Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏?`)) return;
            
            const btn = document.getElementById('deleteUnhealthyBtn');
            btn.disabled = true;
            btn.textContent = '–£–¥–∞–ª—è–µ–º...';
            
            try {
                let deleted = 0;
                for (const id of unhealthyIds) {
                    try {
                        await apiCall(`/api/admin/proxies/${id}`, 'DELETE');
                        deleted++;
                    } catch (e) {
                        console.error(`Failed to delete proxy ${id}:`, e);
                    }
                }
                alert(`–£–¥–∞–ª–µ–Ω–æ ${deleted} –Ω–µ—Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏`);
                healthResults = {};
                loadProxies();
                loadStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '–£–¥–∞–ª–∏—Ç—å –Ω–µ—Ä–∞–±–æ—á–∏–µ';
            }
        }
        
        async function loadTokens() {
            try {
                const response = await fetch(`${API_BASE}/api/tokens`);
                const tokens = await response.json();
                const tbody = document.getElementById('tokenTable');
                tbody.innerHTML = tokens.map(t => `
                    <tr>
                        <td>${t.name}</td>
                        <td>${t.base}/${t.quote}</td>
                        <td>${(t.dexes || ['auto']).join(', ')}</td>
                        <td class="${t.is_active ? 'status-active' : 'status-inactive'}">
                            ${t.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </td>
                        <td>${new Date(t.created_at).toLocaleDateString()}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteToken('${t.name}')">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading tokens:', error);
            }
        }
        
        async function deleteToken(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω ${name}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;
            try {
                await apiCall(`/api/admin/tokens/${encodeURIComponent(name)}`, 'DELETE');
                loadTokens();
                loadStats();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // ============== Product Keys Functions ==============
        
        async function loadProductKeys() {
            try {
                const response = await apiCall('/api/admin/keys');
                const keys = await response.json();
                const tbody = document.getElementById('keysTable');
                tbody.innerHTML = keys.map(k => `
                    <tr>
                        <td>${k.id}</td>
                        <td>${k.username}</td>
                        <td style="font-family: monospace; font-size: 12px;">${k.key}</td>
                        <td class="${k.is_active ? 'status-active' : 'status-inactive'}">
                            ${k.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á—ë–Ω'}
                        </td>
                        <td class="${k.is_used ? 'status-active' : 'status-inactive'}">
                            ${k.is_used ? '‚úì ' + (k.used_at ? new Date(k.used_at).toLocaleString() : '') : '–ù–µ—Ç'}
                        </td>
                        <td>${new Date(k.created_at).toLocaleString()}</td>
                        <td class="actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleKey(${k.id})">
                                ${k.is_active ? '–û—Ç–∫–ª' : '–í–∫–ª'}
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteKey(${k.id})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading keys:', error);
            }
        }
        
        async function createProductKey() {
            const username = document.getElementById('keyUsername').value.trim();
            if (!username) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            try {
                const response = await apiCall('/api/admin/keys', 'POST', { username });
                const result = await response.json();
                document.getElementById('keySuccess').textContent = `–ö–ª—é—á —Å–æ–∑–¥–∞–Ω: ${result.key}`;
                document.getElementById('keyUsername').value = '';
                loadProductKeys();
                setTimeout(() => {
                    document.getElementById('keySuccess').textContent = '';
                }, 5000);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞: ' + error.message);
            }
        }
        
        async function toggleKey(id) {
            try {
                await apiCall(`/api/admin/keys/${id}/toggle`, 'PUT');
                loadProductKeys();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function deleteKey(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?')) return;
            try {
                await apiCall(`/api/admin/keys/${id}`, 'DELETE');
                loadProductKeys();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // ============== Default Tokens Functions ==============
        
        async function loadDefaultTokens() {
            try {
                const response = await apiCall('/api/admin/default-tokens');
                const tokens = await response.json();
                const tbody = document.getElementById('defaultTokensTable');
                tbody.innerHTML = tokens.map(t => {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let address = t.jupiter_mint || t.bsc_address || t.matcha_address || '-';
                    if (address && address.length > 20) {
                        address = address.substring(0, 8) + '...' + address.substring(address.length - 6);
                    }
                    return `
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td>${t.base}/${t.quote}</td>
                        <td>${(t.dexes || []).join(', ') || '-'}</td>
                        <td style="font-family: monospace; font-size: 12px;" title="${t.jupiter_mint || t.bsc_address || t.matcha_address || ''}">${address}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-small" onclick="deleteDefaultToken(${t.id})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('Error loading default tokens:', error);
            }
        }
        
        async function bulkAddDefaultTokens() {
            const addressesText = document.getElementById('bulkTokenAddresses').value.trim();
            const dex = document.getElementById('bulkTokenDex').value;
            
            if (!addressesText) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤');
                return;
            }
            
            const addresses = addressesText.split('\n').map(a => a.trim()).filter(a => a);
            
            if (addresses.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–¥—Ä–µ—Å');
                return;
            }
            
            const resultsDiv = document.getElementById('bulkTokenResults');
            resultsDiv.innerHTML = '<p style="color: var(--accent-blue);">–û–±—Ä–∞–±–æ—Ç–∫–∞ ' + addresses.length + ' –∞–¥—Ä–µ—Å–æ–≤...</p>';
            
            try {
                const response = await apiCall('/api/admin/default-tokens/bulk', 'POST', {
                    addresses,
                    dex
                });
                const result = await response.json();
                
                let html = '';
                
                if (result.success && result.success.length > 0) {
                    html += '<div style="margin-bottom: 10px;"><strong style="color: var(--accent-green);">–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ' + result.success.length + '</strong></div>';
                    html += '<ul style="color: var(--accent-green); margin-left: 20px;">';
                    result.success.forEach(s => {
                        html += `<li>${s.name} (${s.symbol}) - ${s.dexes.join(', ')}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (result.failed && result.failed.length > 0) {
                    html += '<div style="margin-top: 10px; margin-bottom: 10px;"><strong style="color: var(--accent-red);">–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å: ' + result.failed.length + '</strong></div>';
                    html += '<ul style="color: var(--accent-red); margin-left: 20px;">';
                    result.failed.forEach(f => {
                        const shortAddr = f.address.length > 20 ? f.address.substring(0, 8) + '...' + f.address.substring(f.address.length - 6) : f.address;
                        html += `<li>${shortAddr}: ${f.error}</li>`;
                    });
                    html += '</ul>';
                }
                
                resultsDiv.innerHTML = html;
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –µ—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ
                if (result.failed.length === 0) {
                    document.getElementById('bulkTokenAddresses').value = '';
                }
                
                loadDefaultTokens();
                
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: var(--accent-red);">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }
        
        async function deleteDefaultToken(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;
            try {
                await apiCall(`/api/admin/default-tokens/${id}`, 'DELETE');
                loadDefaultTokens();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>
